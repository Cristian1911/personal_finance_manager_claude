name: Build & Deploy

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  REPO: cristian1911/personal_finance_manager_claude
  GHCR_USERNAME: ${{ github.repository_owner }}


jobs:
  ghcr-preflight:
    runs-on: ubuntu-latest

    steps:
      - name: Validate GHCR read PAT and owner
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT_READ }}
          GHCR_USERNAME: ${{ env.GHCR_USERNAME }}
          REPO: ${{ env.REPO }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${GHCR_PAT:-}" ]; then
            echo "❌ GHCR_PAT_READ is empty or missing."
            exit 1
          fi

          response_headers=$(mktemp)
          response_body=$(mktemp)

          http_code=$(curl -sS -o "$response_body" -D "$response_headers" -w "%{http_code}" \
            -H "Authorization: Bearer ${GHCR_PAT}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user)

          if [ "$http_code" != "200" ]; then
            echo "❌ GHCR_PAT_READ is invalid or unauthorized for GitHub API (status $http_code)."
            cat "$response_body"
            exit 1
          fi

          scopes=$(grep -i '^x-oauth-scopes:' "$response_headers" | sed 's/^.*: //I' | tr -d '\r')
          scopes_normalized=$(echo "$scopes" | tr -d ' ')
          token_user=$(jq -r '.login // empty' "$response_body")

          if [ -z "$token_user" ]; then
            echo "❌ Could not resolve token owner from GitHub API."
            exit 1
          fi

          if [[ ",$scopes_normalized," != *",read:packages,"* ]]; then
            echo "❌ GHCR_PAT_READ is missing scope: read:packages"
            echo "Scopes found: ${scopes:-<none>}"
            exit 1
          fi

          if [ "$token_user" != "$GHCR_USERNAME" ]; then
            echo "❌ Token owner mismatch."
            echo "Expected owner: $GHCR_USERNAME"
            echo "Token owner: $token_user"
            exit 1
          fi

          package_name="${REPO##*/}"
          package_status=$(curl -sS -o /tmp/pkg.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GHCR_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/users/${GHCR_USERNAME}/packages/container/${package_name}")

          if [ "$package_status" = "200" ]; then
            echo "✅ GHCR_PAT_READ scope/owner OK and package metadata is readable."
          elif [ "$package_status" = "404" ]; then
            echo "ℹ️ Package '${package_name}' not found yet for user '${GHCR_USERNAME}'."
            echo "Build can still create it if token has write permissions."
          else
            echo "❌ Token cannot read package metadata (status $package_status)."
            cat /tmp/pkg.json
            exit 1
          fi

      - name: Validate GHCR write PAT and owner
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT_WRITE }}
          GHCR_USERNAME: ${{ env.GHCR_USERNAME }}
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${GHCR_PAT:-}" ]; then
            echo "❌ GHCR_PAT_WRITE is empty or missing."
            exit 1
          fi

          response_headers=$(mktemp)
          response_body=$(mktemp)

          http_code=$(curl -sS -o "$response_body" -D "$response_headers" -w "%{http_code}" \
            -H "Authorization: Bearer ${GHCR_PAT}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/user)

          if [ "$http_code" != "200" ]; then
            echo "❌ GHCR_PAT_WRITE is invalid or unauthorized for GitHub API (status $http_code)."
            cat "$response_body"
            exit 1
          fi

          scopes=$(grep -i '^x-oauth-scopes:' "$response_headers" | sed 's/^.*: //I' | tr -d '\r')
          scopes_normalized=$(echo "$scopes" | tr -d ' ')
          token_user=$(jq -r '.login // empty' "$response_body")

          if [ -z "$token_user" ]; then
            echo "❌ Could not resolve write token owner from GitHub API."
            exit 1
          fi

          if [[ ",$scopes_normalized," != *",write:packages,"* ]]; then
            echo "❌ GHCR_PAT_WRITE is missing scope: write:packages"
            echo "Scopes found: ${scopes:-<none>}"
            exit 1
          fi

          if [ "$token_user" != "$GHCR_USERNAME" ]; then
            echo "❌ Write token owner mismatch."
            echo "Expected owner: $GHCR_USERNAME"
            echo "Token owner: $token_user"
            exit 1
          fi

          echo "✅ GHCR_PAT_WRITE scope/owner OK."

  build-and-push:
    runs-on: ubuntu-latest
    needs: ghcr-preflight
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT_WRITE }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push webapp image
        uses: docker/build-push-action@v6
        with:
          context: ./webapp
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO }}:webapp-latest
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push pdf-parser image
        uses: docker/build-push-action@v6
        with:
          context: ./services/pdf_parser
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO }}:parser-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate GHCR token can read images
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT_READ }}

      - name: Verify images are pullable from GHCR
        run: |
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.REPO }}:webapp-latest > /dev/null
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.REPO }}:parser-latest > /dev/null

      - name: Deploy to Hostinger VPS
        uses: hostinger/deploy-on-vps@v2
        with:
          api-key: ${{ secrets.HOSTINGER_API_KEY }}
          virtual-machine: ${{ vars.HOSTINGER_VM_ID }}
          project-name: personal-finance-manager
          docker-compose-path: docker-compose.prod.yml
          environment-variables: |
            GITHUB_REPO=${{ env.REPO }}
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
            DOMAIN=${{ vars.DOMAIN }}
            GHCR_USERNAME=${{ env.GHCR_USERNAME }}
            GHCR_TOKEN=${{ secrets.GHCR_PAT_READ }}
