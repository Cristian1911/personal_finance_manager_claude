name: Build & Deploy

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/deploy.yml'
      - 'webapp/**'
      - 'packages/shared/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'services/pdf_parser/**'
      - 'docker-compose.prod.yml'
      - 'infra/**'
  workflow_dispatch:
    inputs:
      build_webapp:
        description: 'Force build & push webapp image'
        required: true
        default: false
        type: boolean
      build_parser:
        description: 'Force build & push parser image'
        required: true
        default: false
        type: boolean
      run_deploy:
        description: 'Run deploy step after builds'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  REPO: cristian1911/personal_finance_manager_claude
  GHCR_USERNAME: cristian1911


jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      webapp_changed: ${{ steps.filter.outputs.webapp_changed }}
      parser_changed: ${{ steps.filter.outputs.parser_changed }}
      deploy_changed: ${{ steps.filter.outputs.deploy_changed }}
      any_deploy: ${{ steps.filter.outputs.any_deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed areas
        id: filter
        shell: bash
        run: |
          set -euo pipefail

          event_name="${{ github.event_name }}"
          force_webapp='${{ github.event.inputs.build_webapp || 'false' }}'
          force_parser='${{ github.event.inputs.build_parser || 'false' }}'
          force_deploy='${{ github.event.inputs.run_deploy || 'false' }}'

          if [ "$event_name" = "workflow_dispatch" ]; then
            files=""
          else
            before="${{ github.event.before }}"
            after="${{ github.sha }}"

            if [ -z "$before" ] || [ "$before" = "0000000000000000000000000000000000000000" ]; then
              files=$(git ls-files)
            else
              files=$(git diff --name-only "$before" "$after")
            fi
          fi

          webapp_changed=false
          parser_changed=false
          deploy_changed=false

          if echo "$files" | grep -qE '^(webapp/|packages/shared/|package\.json$|pnpm-lock\.yaml$|pnpm-workspace\.yaml$)'; then
            webapp_changed=true
          fi

          if echo "$files" | grep -qE '^services/pdf_parser/'; then
            parser_changed=true
          fi

          if echo "$files" | grep -qE '^(docker-compose.prod.yml|infra/|\.github/workflows/deploy.yml)'; then
            deploy_changed=true
          fi

          if [ "$force_webapp" = "true" ]; then
            webapp_changed=true
          fi

          if [ "$force_parser" = "true" ]; then
            parser_changed=true
          fi

          if [ "$force_deploy" = "true" ]; then
            deploy_changed=true
          fi

          any_deploy=false
          if [ "$webapp_changed" = "true" ] || [ "$parser_changed" = "true" ] || [ "$deploy_changed" = "true" ]; then
            any_deploy=true
          fi

          echo "webapp_changed=$webapp_changed" >> "$GITHUB_OUTPUT"
          echo "parser_changed=$parser_changed" >> "$GITHUB_OUTPUT"
          echo "deploy_changed=$deploy_changed" >> "$GITHUB_OUTPUT"
          echo "any_deploy=$any_deploy" >> "$GITHUB_OUTPUT"
     
  build-and-push-webapp:
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.webapp_changed == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT_WRITE }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push webapp image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./webapp/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO }}:webapp-latest
          build-args: |
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-and-push-parser:
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.parser_changed == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT_WRITE }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push pdf-parser image
        uses: docker/build-push-action@v6
        with:
          context: ./services/pdf_parser
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO }}:parser-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: [changes, build-and-push-webapp, build-and-push-parser]
    if: |
      always() &&
      needs.changes.outputs.any_deploy == 'true' &&
      (needs.changes.outputs.deploy_changed == 'true' || 
       needs.changes.outputs.webapp_changed == 'true' || 
       needs.changes.outputs.parser_changed == 'true') &&
      needs.build-and-push-webapp.result != 'failure' &&
      needs.build-and-push-parser.result != 'failure'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate GHCR token can read images
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT_READ }}

      - name: Verify images are pullable from GHCR
        run: |
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.REPO }}:webapp-latest > /dev/null
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.REPO }}:parser-latest > /dev/null

      - name: Deploy to Hostinger VPS
        uses: hostinger/deploy-on-vps@v2
        with:
          api-key: ${{ secrets.HOSTINGER_API_KEY }}
          virtual-machine: ${{ vars.HOSTINGER_VM_ID }}
          project-name: personal-finance-manager
          docker-compose-path: docker-compose.prod.yml
          environment-variables: |
            GITHUB_REPO=${{ env.REPO }}
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
            NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
            SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
            SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
            DOMAIN=${{ vars.DOMAIN }}
            GHCR_USERNAME=${{ env.GHCR_USERNAME }}
            GHCR_TOKEN=${{ secrets.GHCR_PAT_READ }}
